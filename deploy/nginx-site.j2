upstream express-{{hostname}} {
  # fail_timeout=0 means we always retry an upstream even if it failed
  # to return a good HTTP response
  server localhost:{{express_port}} fail_timeout=0;
}

server {
  listen 80 default;
  #This matches peterlyons.com and *.peterlyons.com
  server_name .{{hostname}};
  #This is essential so we can use the same configuration
  #in production and staging
  server_name_in_redirect off;
  charset utf-8;
  access_log /var/log/nginx.{{hostname}}.access.log;
  error_log /var/log/nginx.{{hostname}}.error.log;
  gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

  location / {
    root {{www_root}};
    try_files $uri $uri.html $uri/index.html @app;
  }

  location @app {
    rewrite /app(.*) $1 break;
    error_page 404 /error404.html;
    error_page 502 503 504 /error500.html;
    proxy_redirect off;
    proxy_pass http://express-{{hostname}};
  }
}
