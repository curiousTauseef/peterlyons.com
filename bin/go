#!/bin/bash
##### helper functions #####
autoinstall_makitso() {
  [ -f makitso/makitso.sh ] && return
  git submodule update --init
}

autoinstall_python() {
  [ -x python/bin/python ] && return
  ./makitso/scripts/python/install_python.sh python
}

autoinstall_ansible() {
  autoinstall_python
  if [ ! -x ansible/bin/ansible ]; then
    git submodule update --init
  fi
  [ -e python/lib/python2.7/site-packages/paramiko ] && return
  ./python/bin/pip install -r requirements-ansible.txt
}

autoinstall_node() {
  autoinstall_makitso
  [ -x node/bin/node ] && return
  local NODE_VERSION=$(./makitso/scripts/json/get_value.py package.json engines.node)
  ./makitso/scripts/node/install_node.sh node "${NODE_VERSION}"
}

autoinstall_npm_dependencies() {
  autoinstall_node
  [ -d node_modules/express ] && return
  npm install
}

##### main code #####
main() {
  cd $(dirname "$0")/..
  PATH="${PWD}/python/bin"
  PATH="${PATH}:${PWD}/node/bin"
  PATH="${PATH}:${PWD}/node_modules/.bin"
  #Need the basics like dirname et al
  PATH="${PATH}:/usr/bin:/bin"
  export PATH

  case "$1" in
    ansible|ansible-playbook)
      autoinstall_ansible
      ANSIBLE_COMMAND="$1"
      shift
      exec "./bin/${ANSIBLE_COMMAND}" "$@"
    ;;
    *)
      echo "Usage: $(basename $0) [ansible|ansible-playbook]"
    ;;
  esac
}

main "$@"
